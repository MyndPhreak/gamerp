@using Sandbox;
@using Sandbox.UI;
@using GameRP.Economy;
@using GameRP.Systems;
@using System;
@using System.Threading.Tasks;

@namespace GameRP.UI
@inherits PanelComponent

<root class="atm-panel">
    @if (IsLoading)
    {
        <div class="atm-loading">
            <div class="spinner"></div>
            <label>Connecting to bank...</label> 
        </div>
    } 
    else if (WalletData != null && !ShowTransactionForm)
    {
        <div class="atm-header">
            <label class="atm-title">ATM</label>
            <div class="close-btn" @onclick=@Close>×</div>
        </div> 

        <div class="atm-balance">
            <label class="balance-label">Current Balance</label>
            <label class="balance-value">$@WalletData.Balance.ToString("N2")</label>
        </div>

        <div class="atm-actions">
            <div class="atm-btn deposit" @onclick=@(() => ShowTransaction(true))>
                <label>Deposit</label>
            </div>
            <div class="atm-btn withdraw" @onclick=@(() => ShowTransaction(false))>
                <label>Withdraw</label>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <div class="status-message @StatusClass">
                <label>@StatusMessage</label>
            </div>
        }
    }
    else if (ShowTransactionForm)
    {
        <div class="atm-header">
            <label class="atm-title">@(IsDeposit ? "Deposit" : "Withdraw")</label>
            <div class="close-btn" @onclick=@CancelTransaction>←</div>
        </div>

        <div class="atm-balance">
            <label class="balance-label">Current Balance</label>
            <label class="balance-value">$@WalletData.Balance.ToString("N2")</label>
        </div>

        <div class="transaction-form">
            <label class="input-label">Amount</label>
            <input class="amount-input" type="number" @bind="TransactionAmount" placeholder="0.00" step="0.01" min="0.01" />

            <div class="quick-amounts">
                <div class="quick-btn" @onclick=@(() => TransactionAmount = 100)>$100</div>
                <div class="quick-btn" @onclick=@(() => TransactionAmount = 500)>$500</div>
                <div class="quick-btn" @onclick=@(() => TransactionAmount = 1000)>$1,000</div>
                <div class="quick-btn" @onclick=@(() => TransactionAmount = 5000)>$5,000</div>
            </div>

            <div class="atm-btn confirm @(IsDeposit ? "deposit" : "withdraw")" @onclick=@ProcessTransaction>
                <label>@(IsDeposit ? "Deposit" : "Withdraw") $@TransactionAmount.ToString("N2")</label>
            </div>

            @if (!string.IsNullOrEmpty(StatusMessage))
            {
                <div class="status-message @StatusClass">
                    <label>@StatusMessage</label>
                </div>
            }
        </div>
    }
</root>

<style>
    .atm-panel {
        width: 400px;
        background-color: rgba(20, 20, 30, 0.95);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        font-family: 'Poppins', sans-serif;
        color: white;
    }

    .atm-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .atm-title {
        font-size: 24px;
        font-weight: 600;
    }

    .close-btn {
        width: 32px;
        height: 32px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 24px;
        transition: background-color 0.2s;
    }

    .close-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .atm-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        padding: 40px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #4CAF50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .atm-balance {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 24px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
    }

    .balance-label {
        font-size: 14px;
        opacity: 0.8;
        margin-bottom: 8px;
    }

    .balance-value {
        font-size: 36px;
        font-weight: 700;
    }

    .atm-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .atm-btn {
        flex: 1;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .atm-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .atm-btn.deposit {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }

    .atm-btn.withdraw {
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }

    .atm-btn.confirm {
        width: 100%;
        margin-top: 16px;
    }

    .transaction-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .input-label {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .amount-input {
        background-color: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 24px;
        font-weight: 600;
        color: white;
        text-align: center;
    }

    .amount-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .quick-amounts {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin: 8px 0;
    }

    .quick-btn {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 8px;
        border-radius: 6px;
        text-align: center;
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .quick-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .status-message {
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        font-size: 14px;
        margin-top: 12px;
    }

    .status-message.success {
        background-color: rgba(76, 175, 80, 0.2);
        border: 1px solid #4CAF50;
    }

    .status-message.error {
        background-color: rgba(244, 67, 54, 0.2);
        border: 1px solid #f44336;
    }
</style>

@code
{
    [Property] public long SteamId { get; set; }
    [Property] public Action OnClose { get; set; }

    private WalletData WalletData { get; set; }
    private bool IsLoading { get; set; } = true;
    private bool ShowTransactionForm { get; set; } = false;
    private bool IsDeposit { get; set; } = false;
    private decimal TransactionAmount { get; set; } = 0;
    private string StatusMessage { get; set; } = "";
    private string StatusClass { get; set; } = "";

    public void Initialize()
    {
        Log.Info("[AtmPanel] Initialize called");
        Log.Info($"[AtmPanel] Steam ID: {SteamId}");
        Log.Info($"[AtmPanel] Loading wallet for Steam ID: {SteamId}");
        _ = LoadWallet();
    }

    private async Task LoadWallet()
    {
        Log.Info("[AtmPanel] LoadWallet started");
        IsLoading = true;
        StatusMessage = "";
        StateHasChanged();

        try
        {
            Log.Info($"[AtmPanel] Requesting wallet for Steam ID: {SteamId}");
            WalletData = await EconomySystem.Api.GetWalletAsync(SteamId);

            if (WalletData == null)
            {
                Log.Warning("[AtmPanel] Wallet data is null");
                StatusMessage = "Failed to connect to bank";
                StatusClass = "error";
            }
            else
            {
                Log.Info($"[AtmPanel] Wallet loaded successfully: ${WalletData.Balance}");
            }
        }
        catch (Exception ex)
        {
            Log.Error($"[AtmPanel] Error loading wallet: {ex.Message}");
            StatusMessage = $"Error: {ex.Message}";
            StatusClass = "error";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
            Log.Info("[AtmPanel] LoadWallet finished");
        }
    }

    private void ShowTransaction(bool isDeposit)
    {
        IsDeposit = isDeposit;
        ShowTransactionForm = true;
        TransactionAmount = 0;
        StatusMessage = "";
        StateHasChanged();
    }

    private void CancelTransaction()
    {
        ShowTransactionForm = false;
        StatusMessage = "";
        StateHasChanged();
    }

    private async Task ProcessTransaction()
    {
        if (TransactionAmount <= 0)
        {
            StatusMessage = "Amount must be greater than 0";
            StatusClass = "error";
            StateHasChanged();
            return;
        }

        IsLoading = true;
        StatusMessage = "";
        StateHasChanged();

        try
        {
            WalletData result = null;

            if (IsDeposit)
            {
                result = await EconomySystem.Deposit(SteamId, TransactionAmount, "ATM Deposit");
            }
            else
            {
                result = await EconomySystem.Withdraw(SteamId, TransactionAmount, "ATM Withdrawal");
            }

            if (result != null)
            {
                WalletData = result;
                StatusMessage = $"Transaction successful! New balance: ${result.Balance:N2}";
                StatusClass = "success";

                // Reset form after 2 seconds
                _ = Task.Delay(2000).ContinueWith(_ =>
                {
                    ShowTransactionForm = false;
                    StatusMessage = "";
                    StateHasChanged();
                });
            }
            else
            {
                StatusMessage = "Transaction failed";
                StatusClass = "error";
            }
        }
        catch (Exception ex)
        {
            Log.Error($"[ATM] Transaction error: {ex.Message}");
            StatusMessage = $"Error: {ex.Message}";
            StatusClass = "error";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        OnClose?.Invoke();
    }

    protected override int BuildHash()
    {
        return System.HashCode.Combine(WalletData?.Balance, IsLoading, ShowTransactionForm, TransactionAmount, StatusMessage);
    }
}
