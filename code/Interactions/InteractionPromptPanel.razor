@using Sandbox;
@using Sandbox.UI;
@using GameRP.Interactions;
@using System;

@namespace GameRP.Interactions
@inherits PanelComponent

<root>
    @if (Interactable != null && Interactable.IsLookingAt)
    {
        <div class="interaction-container">
            <div class="interaction-content">
                @if (Interactable.HoldDuration > 0)
                {
                    <div class="circular-progress">
                        <div class="circle-background"></div>
                        @{
                            var progress = Interactable.HoldProgress;
                            // First half (0-50%): right half rotates 0-180°
                            var rightRotation = Math.Min(progress * 2, 1) * 180;
                            // Second half (50-100%): left half rotates 0-180°
                            var leftRotation = Math.Max((progress - 0.5f) * 2, 0) * 180;
                        }
                        <div class="progress-left" style="transform: rotate(@leftRotation deg)"></div>
                        <div class="progress-right" style="transform: rotate(@rightRotation deg)"></div>
                        <div class="circle-cover">
                            <div class="key-text">E</div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="key-display">E</div>
                }

                <div class="text-label">@Interactable.InteractionText</div>
            </div>
        </div>
    }
</root>

@code
{
    [Property] public Interactable Interactable { get; set; }
    [Property] public Vector2 PanelSize { get; set; } = new Vector2(400, 150);

    private Sandbox.WorldPanel _worldPanel;

    protected override void OnEnabled()
    {
        base.OnEnabled();

        // Create WorldPanel component on the same GameObject
        _worldPanel = Components.GetOrCreate<Sandbox.WorldPanel>();
        _worldPanel.PanelSize = PanelSize;
    }

    protected override int BuildHash()
    {
        return System.HashCode.Combine(
            Interactable?.IsLookingAt,
            Interactable?.HoldProgress,
            Interactable?.InteractionText
        );
    }
}
