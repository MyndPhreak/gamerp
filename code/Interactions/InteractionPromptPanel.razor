@using Sandbox;
@using Sandbox.UI;
@using GameRP.Interactions;
@using System;

@namespace GameRP.Interactions
@inherits PanelComponent

<root>
    @if (Interactable != null && Interactable.IsLookingAt)
    {
        <div class="interaction-container">
            <div class="interaction-content">
                @if (Interactable.HoldDuration > 0)
                {
                    <div class="progress-ring">
                        <div class="progress-ring-bg"></div>
                        <div class="progress-ring-fill" style="transform: rotate(@(GetProgressDegrees())deg)"></div>
                        <label class="progress-key">E</label>
                    </div>
                }
                else
                {
                    <div class="instant-key">
                        <label>E</label>
                    </div>
                }
                <label class="interaction-text">@Interactable.InteractionText</label>
            </div>
        </div>
    }
</root>

@code
{
    [Property] public Interactable Interactable { get; set; }
    [Property] public Vector2 PanelSize { get; set; } = new Vector2(400, 150);

    private Sandbox.WorldPanel _worldPanel;

    protected override void OnEnabled()
    {
        base.OnEnabled();

        // Create WorldPanel component on the same GameObject
        _worldPanel = Components.GetOrCreate<Sandbox.WorldPanel>();
        _worldPanel.PanelSize = PanelSize;
    }

    private float GetProgressDegrees()
    {
        if (Interactable == null) return -90f;
        // Start at -90deg (top) and rotate 1.8 turns (648 degrees) for full progress
        // This makes the half-circle sweep around twice to complete the full circle
        return -90f + (Interactable.HoldProgress * 720f);
    }

    protected override int BuildHash()
    {
        return System.HashCode.Combine(
            Interactable?.IsLookingAt,
            Interactable?.HoldProgress,
            Interactable?.InteractionText
        );
    }
}
